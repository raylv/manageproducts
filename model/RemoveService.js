/*
 * Copyright (C) 2009-2016 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/m/MessageBox","sap/m/MessageToast","nw/epm/refapps/ext/prod/manage/controller/utilities"],function(O,M,a,u){"use strict";function g(p){return(p.indexOf("/")===0?"":"/")+p;}return O.extend("nw.epm.refapps.ext.prod.manage.model.RemoveService",{constructor:function(o,r,A,s,d,b){this._oODataModel=o;this._oResourceBundle=r;this._oApplicationProperties=A;this._oApplicationController=this._oApplicationProperties.getProperty("/applicationController");this._fnShowErrorMessage=s;this._fnDeleteListener=d;this._bBusy=b;},deleteProducts:function(p,A){if(p.length===0){return;}var q,s;if(p.length===1){var P=this._oODataModel.getProperty(g(p[0])+"/Name");q=this._oResourceBundle.getText("ymsg.deleteText",P);s=this._oResourceBundle.getText("ymsg.deleteSuccess",P);}else{q=this._oResourceBundle.getText("ymsg.deleteProducts",p.length);s=this._oResourceBundle.getText("ymsg.deleteMultipleSuccess",p.length);}var m=function(t){if(t){a.show(s);}if(A){A(t);}};this._confirmDeletionByUser({bDraft:false,question:q},p,m);},deleteProduct:function(p){this.deleteProducts([p]);},deleteProductDraft:function(p,d,D){var q=this._oResourceBundle.getText("ymsg.warningConfirm");var t=this._oResourceBundle.getText("xtit.warning");var c=function(P){if(d){d(P);}};this._confirmDeletionByUser({bDraft:true,title:t,question:q,icon:M.Icon.WARNING},[p],null,D,c);},deleteEntityWithoutConfirmationDialog:function(p,A){return this._callDeleteService([p],A);},_confirmDeletionByUser:function(c,p,A,d,D){var f=function(){var P=this._callDeleteService(p,A);if(D){D(P);}}.bind(this);var l=this._oResourceBundle.getText("xbut.leavePage");var s=(c.bDraft)?l:M.Action.OK;M.show(c.question,{icon:c.icon||M.Icon.WARNING,title:c.title||this._oResourceBundle.getText("xtit.delete"),actions:[s,M.Action.CANCEL],onClose:function(o){if(o===s){f();}else if(d){d();}},styleClass:u.getContentDensityClass()});},_callDeleteService:function(p,A){if(this._bBusy){this._oApplicationProperties.setProperty("/isBusyDeleting",true);}if(this._fnDeleteListener){this._fnDeleteListener(true,p);}var f=function(e){jQuery.sap.log.error("EPM Refapp Products","Failed to delete product while calling backend service");this._fnShowErrorMessage(e);}.bind(this);var s=function(S){if(this._bBusy){this._oApplicationProperties.setProperty("/isBusyDeleting",false);}var t=p.length===1||S;if(A){A(t);}if(this._fnDeleteListener){this._fnDeleteListener(false,p,t);}}.bind(this);return p.length===1?this._deleteOneEntity(p[0],s,f):this._deleteProducts(p,s,f);},_deleteOneEntity:function(p,s,f){var P=new Promise(function(r,R){this._oODataModel.remove(g(p),{success:r,error:R,async:true});}.bind(this));P.then(s,f);return P;},_deleteProducts:function(p,A,f){var d="BatchDelete",n=0,s=function(){n++;},S=function(){if(n){this._showMessageForPartiallyFailedDeletes(n);}A(!n);}.bind(this),P=new Promise(function(r,R){for(var i=0;i<p.length;i++){this._oODataModel.remove(g(p[i]),{error:s,batchGroupId:d,changeSetId:i.toString()});}this._oODataModel.submitChanges({batchGroupId:d,success:r,error:R});}.bind(this));P.then(S,f);return P;},_showMessageForPartiallyFailedDeletes:function(f){M.show(this._oResourceBundle.getText("ymsg.deleteNProductsFailed",f),{icon:M.Icon.ERROR,title:this._oResourceBundle.getText("xtit.error"),styleClass:u.getContentDensityClass()});}});});
