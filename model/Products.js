/*
 * Copyright (C) 2009-2016 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/model/json/JSONModel","./RemoveService","nw/epm/refapps/ext/prod/manage/controller/messages"],function(O,J,R,m){"use strict";return O.extend("nw.epm.refapps.ext.prod.manage.model.Products",{constructor:function(c,M){this._oResourceBundle=c.getModel("i18n").getResourceBundle();this._oODataModel=c.getModel();this._oApplicationProperties=c.getModel("appProperties");this._oApplicationController=this._oApplicationProperties.getProperty("/applicationController");this._fnDeleteListener=this._oApplicationController.deleteListener.bind(this._oApplicationController);this._oMainView=M;this._oWhenNoDraft=new Promise(function(r){r();});this._fnSetBackBusyDraftState=this._oApplicationProperties.setProperty.bind(this._oApplicationProperties,"/isBusyCreatingDraft",false);},getPathForProductId:function(p){return this._oODataModel.createKey("/Products",{Id:p});},getPathForDraftId:function(d){return this._oODataModel.createKey("/ProductDrafts",{Id:d});},deleteProducts:function(p,a){var d=this._getDeleteHelper(true,true);d.deleteProducts(p,a);},deleteProduct:function(p,a,w){var d=this._getDeleteHelper(true,true);if(w){d.deleteEntityWithoutConfirmationDialog(p,a,true);}else{d.deleteProduct(p,a);}},deleteProductDraft:function(p,a,d){var D=this._getDeleteHelper(false,false);if(this._oApplicationProperties.getProperty("/isDirty")){var f=function(P){this._setWhenNoDraft(P);if(a){a();}}.bind(this);D.deleteProductDraft(p,f,d);}else{this._setWhenNoDraft(D.deleteEntityWithoutConfirmationDialog(p,null,false));if(a){a();}}},_setWhenNoDraft:function(p){this._oWhenNoDraft=p;p.catch(this._oApplicationProperties.setProperty.bind(this._oApplicationProperties,"/lostDraftReadState",-1));},deleteImageDraft:function(p,a){var d=this._getDeleteHelper(false,true);d.deleteEntityWithoutConfirmationDialog(p,a,false);},createProductDraft:function(p){this._oApplicationProperties.setProperty("/isBusyCreatingDraft",true);var c=function(){var n={ProductId:""};this._oODataModel.create("/ProductDrafts",n,{success:p,error:this._getErrorForProcessing("isBusyCreatingDraft")});}.bind(this);this._oWhenNoDraft.then(c,this._fnSetBackBusyDraftState);},readProductDraft:function(h,e){var s=function(r){var p=r.results[0];var d=p&&p.Id;h(d,p);};this._oODataModel.read("/ProductDrafts",{success:s,error:e});},deleteDraft:function(d,a){this._oApplicationProperties.setProperty("/isDirty",false);var p=this._oODataModel.createKey("ProductDrafts",{Id:d});this.deleteProductDraft(p,a,null);},copyProductToDraft:function(p,n){this._callFunctionAndNavToProductDraft("/CopyProduct",p,n);},getProductDraftFromProductId:function(p,n){this._callFunctionAndNavToProductDraft("/EditProduct",p,n);},_callFunctionAndNavToProductDraft:function(f,p,n){this._oApplicationProperties.setProperty("/isBusyCreatingDraft",true);var c=function(){this._callFunctionImport(f,{ProductId:p},function(r){if(r&&r.Id){n(r.Id);}},"isBusyCreatingDraft");}.bind(this);this._oWhenNoDraft.then(c,this._fnSetBackBusyDraftState);},_callFunctionImport:function(f,u,a,p){this._oODataModel.callFunction(f,{method:"POST",urlParameters:u,success:a,error:this._getErrorForProcessing(p)});},activateProduct:function(d,a){this._oApplicationProperties.setProperty("/isBusySaving",true);var r=function(){this._oApplicationProperties.setProperty("/isBusySaving",false);}.bind(this);this.oDraftToActivate={sDraftId:this._oApplicationProperties.getProperty("/productId"),fnAfterActivation:a};this._submitChanges(r,d);},saveProductDraft:function(a){this._submitChanges(null,a);},_submitChanges:function(s,a){if(this._bIsChanging){return;}if(this._oODataModel.hasPendingChanges()){this._sMessage=null;var S=function(r){this._bIsChanging=false;if(!this._oODataModel.hasPendingChanges()||!this._sMessage){var i;for(i=0;i<r.__batchResponses.length&&!this._sMessage;i++){var e=r.__batchResponses[i];if(e.response){this._sMessage=m.extractErrorMessageFromDetails(e.response.body);}}}if(this._sMessage){a(this._sMessage);}else{this._submitChanges(s,a);}}.bind(this);this._bIsChanging=true;var p={success:S,error:s,batchGroupId:"editproduct"};this._oODataModel.submitChanges(p);}else if(this.oDraftToActivate){if(this._sMessage){this._oApplicationProperties.setProperty("/isBusySaving",false);}else{this._callFunctionImport("/ActivateProduct",{ProductDraftId:this.oDraftToActivate.sDraftId},this.oDraftToActivate.fnAfterActivation,"isBusySaving");}this.oDraftToActivate=null;}},saveSelectProductDraft:function(){this._oODataModel.submitChanges(null,this.onSubmitDraftErrorSelect);},onSubmitDraftErrorSelect:function(e){m.showErrorMessage(e,this._oMainView);},_getErrorForProcessing:function(p){return function(e){this._oApplicationProperties.setProperty("/"+p,false);m.showErrorMessage(e,this._oMainView);}.bind(this);},_getDeleteHelper:function(c,w){return new R(this._oODataModel,this._oResourceBundle,this._oApplicationProperties,this._getErrorForProcessing("isBusyDeleting"),c&&this._fnDeleteListener,w);}});});
