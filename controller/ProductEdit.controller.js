/*
 * Copyright (C) 2009-2016 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/providers/ValueHelpProvider","sap/ui/model/Sorter","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterType","sap/ui/model/FilterOperator","sap/ui/core/ValueState","./SubControllerForShare","nw/epm/refapps/ext/prod/manage/model/formatter"],function(C,a,J,M,V,S,D,F,b,c,d,e,f){"use strict";function A(g){var h=null;for(var i=0;i<g.length;i++){var E=g[i];if(E){if(h){h.push(E);}}else if(!h){h=g.slice(0,i);}}return h||g;}return C.extend("nw.epm.refapps.ext.prod.manage.controller.ProductEdit",{formatter:f,onInit:function(){this._oView=this.getView();this._initViewPropertiesModel();var o=this.getOwnerComponent();this._oApplicationProperties=o.getModel("appProperties");this._oApplicationController=this._oApplicationProperties.getProperty("/applicationController");this._oResourceBundle=o.getModel("i18n").getResourceBundle();this._oHelper=this._oApplicationController.getODataHelper();this._oSubControllerForShare=new e(this._oView,this._oResourceBundle);this._oCategory=this.byId("categoryBox");this._oSubcategory=this.byId("subcategoryBox");this._aMandatoryFields=this._getMandatoryFields();this._aInputFields=this._aMandatoryFields.concat(this._getNonMandatoryInputFields());this._initSubViewImageUpload();var m=o.getModel();m.attachMetadataLoaded(function(){var i=this.byId("supplierInput"),g=new M(m),s="SupplierName",h=o.getMetadata().getConfig(),j=h.serviceConfig.name,k=j+".ProductDraft/"+s,v=g.getValueListAnnotation(k);if(i){new V({annotation:v.primaryValueListAnnotation,additionalAnnotations:v.additionalAnnotations,control:i,model:m,preventInitialDataFetchInValueHelpDialog:true,supportMultiSelect:false,supportRanges:false,fieldName:s,title:s});i.setShowValueHelp(true);}},this);},_initViewPropertiesModel:function(){this._oViewProperties=new J({dataLoaded:false});this._oView.setModel(this._oViewProperties,"viewProperties");},_getMandatoryFields:function(){return A([this.byId("productNameInput"),this.byId("priceInput"),this.byId("currencyBox"),this._oCategory,this._oSubcategory,this.byId("descriptionArea"),this.byId("supplierInput"),this.byId("unitOfMeasureBox")]);},_getNonMandatoryInputFields:function(){return A([this.byId("lengthInput"),this.byId("widthInput"),this.byId("heightInput"),this.byId("weightInput")]);},_initSubViewImageUpload:function(){var s=this.byId("View_ImageUpload");if(s){s.getController().setInitData({oResourceBundle:this._oResourceBundle,oDataHelper:this._oHelper,fnDirty:this._setDirty.bind(this)});}},show:function(){var p=this._oApplicationProperties.getProperty("/productId");this._oViewProperties.setProperty("/dataLoaded",false);this._resetValueStates();this._sContextPath=this._oHelper.getPathForDraftId(p);this._oView.bindElement(this._sContextPath,{expand:"Images"});var B=this._oView.getBindingContext();if(B&&B.getPath()===this._sContextPath){this._oView.getElementBinding().refresh();}this._oView.getElementBinding().attachEventOnce("dataReceived",function(){B=this._oView.getBindingContext();if(B){this._oApplicationProperties.setProperty("/isDirty",B.getProperty("IsDirty"));this._oViewProperties.setProperty("/dataLoaded",true);this._setCategoryFilter(B);}else{this._oApplicationController.showProductDetailPage(p);}this._oApplicationProperties.setProperty("/isBusyCreatingDraft",false);},this);},leave:function(){this._oView.unbindElement();},onSavePressed:function(){if(!this._checkAndMarkEmptyMandatoryFields()&&!this._fieldWithErrorState()){var g=function(o,r){for(var i=0;i<r.__batchResponses.length;i++){if(r.__batchResponses[i].response){if(jQuery.sap.startsWith(r.__batchResponses[i].response.body,"{\"error\":")){var E=new J();E.setJSON(r.__batchResponses[i].response.body);var m=E.getProperty("/error/message/value");if(o){o.setValueState("Error");o.setValueStateText(m);}return false;}}}return true;},h=function(p){this._oApplicationProperties.setProperty("/masterBusyIndicatorDelay",0);this._oApplicationController.showProductDetailPage(p.Id,true);this._oApplicationProperties.setProperty("/isBusySaving",false);var m=this._oResourceBundle.getText("ymsg.saveText",p.Name);sap.ui.require(["sap/m/MessageToast"],function(i){i.show(m);});}.bind(this);this._oHelper.activateProduct(g,h);}},onCancelPressed:function(){var o=this._oView.getBindingContext().getObject(),n=function(){this._oApplicationProperties.setProperty("/detailBusyIndicatorDelay",null);var i=o.IsNewProduct,p=i?(!D.system.phone&&this._oApplicationProperties.getProperty("/lastDisplay")):o.ProductId;if(p){this._oApplicationController.showProductDetailPage(p);}else{this._oApplicationController.navToMaster();}}.bind(this);this._deleteProductDraft(n);},onSharePressed:function(E){this._oSubControllerForShare.openDialog(E);},onNavButtonPress:function(){this._oApplicationController.navBack(true);},_deleteProductDraft:function(g,h){this._oHelper.deleteProductDraft(this._sContextPath,g,h);},onNumberChange:function(E){var o=E.getSource(),n=o.getValue();if(n===""){o.setValue("0");}this._fieldChange(o);},onCategoryChange:function(E){E.getSource().setValueState(d.None);this._setCategoryFilter(this._oView.getBindingContext());},onInputChange:function(E){var o=E.getSource();setTimeout(function(){this._fieldChange(o);}.bind(this),0);},onSubcategoryChange:function(E){var v=this._oSubcategory.getValue();if(!v.trim()){return;}if(this._oCategory){this._oCategory.setValueState(d.None);var s=E.getParameter("selectedItem"),B=s.getBindingContext(),m=B.getProperty("MainCategoryId");if(m!==this._oCategory.getValue()){this._oCategory.setValue(m);}}this._fieldChange(this._oSubcategory);},onSelectChange:function(){this._setDirty();this._oHelper.saveSelectProductDraft();},suggestMethod:function(E){sap.m.InputODataSuggestProvider.suggest(E);},_resetValueStates:function(){jQuery.each(this._aInputFields,function(i,g){g.setValueState(d.None);});},_fieldWithErrorState:function(){return this._aInputFields.some(function(i){return(i.getValueState()===d.Error);});},_fieldChange:function(o){this._setDirty();o.setValueState(d.None);var s=function(m){if(m&&o){o.setValueState("Error");o.setValueStateText(m);}};this._oHelper.saveProductDraft(s);},_checkAndMarkEmptyMandatoryFields:function(){var E=false;jQuery.each(this._aMandatoryFields,function(i,g){if(!g.getValue()||g.getValue().trim()===""){E=true;g.setValueState(d.Error);}});return E;},_setCategoryFilter:function(B){if(this._oSubcategory){var m=B.getProperty("MainCategoryId"),s=B.getProperty("SubCategoryId"),g=m?[new F("MainCategoryName",c.StartsWith,m)]:[],o=this._oSubcategory.getBinding("items");if(m){o.attachEventOnce("change",function(){var h=o.getContexts(),i=h.some(function(E){return s===E.getProperty("Id");}).bind(this);if(!i){this._oSubcategory.setValue(" ");}},this);}else{this._oSubcategory.setValue(" ");}o.filter(g,b.Application);}},_setDirty:function(){this._oApplicationProperties.setProperty("/isDirty",true);}});});
